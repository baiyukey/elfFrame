$.fn.extend({elfKeyword:function(g){var f=$.extend({placeholder:"请在此输入",initData:[],refuseData:[],refuseDataReason:"不允许的字符",regExp:/.+/,inputErr:"不匹配的字符",callback:undefined,inputCallback:undefined},g);var e=$(this);e.addClass("elfKeywordGroup");e.find(".keyword").remove();var b=[];for(var d=0;d<f.initData.length;d++){b.push('<span class="keyword">'+f.initData[d]+"</span>")}e.prepend(b.join(""));if(e.find("input").length===0){e.append('<input type="text" placeholder="'+f.placeholder+'" style="width:10em;">')}else{e.find("input").attr("placeholder",f.placeholder)}var c=e.find("input");var a={input:function(i){var h=i.getKey();switch(h){case 13:a.inputFinish();break;case 32:a.inputFinish();break;case 8:a.removeLast();break;default:break}},inputFinish:function(j){var h=e.attr("data-refuse-value").split(",");var k=e.getElfKeyword();var o=$.trim(c.val()).replace(/[\s\,]+/g,",").split(",");var i=function(q){var s=[];var r={};for(var t=0;t<q.length;t++){if(!r[q[t]]){s.push(q[t]);r[q[t]]=true}}return s};$(".indicate").remove();$("[indicate]").removeAttr("indicate");o=i(o);var p=[];o.forEach(function(r,q){if(r!==""&&r!==" "){p.push(r)}});if(p.length===0){return false}var n=[];var l=[];var m=[];p.forEach(function(r,q){if(!f.regExp.test(r)){n.push(r)}if($.inArray(r,h)>=0){l.push(r)}if($.inArray(r,k)>=0){m.push(r)}});if(l.length>0){e.inputErr(f.refuseDataReason+":"+l.join(","))}else{if(n.length>0){e.inputErr(f.inputErr+":"+n.join(","))}else{if(m.length>0){e.inputErr("重复的数据:"+m.join(","))}else{p.forEach(function(r,q){if(e.find(".keyword").length>0){e.find(".keyword:last").after('<span class="keyword">'+r+"</span>")}else{e.prepend('<span class="keyword">'+r+"</span>")}});if(typeof(f.inputCallback)==="function"){f.inputCallback.call(this)}c[0].value="";setTimeout(function(){if(typeof("_isBlur")==="undefined"){c[0].focus()}},50)}}}},removeLast:function(){if(c.val()!==""){return false}$(".indicate").remove();$("[indicate]").removeAttr("indicate");e.find(".keyword:last").remove();if(typeof(f.inputCallback)==="function"){f.inputCallback.call(this)}},remove:function(h){h.preventDefault();$(".indicate").remove();$("[indicate]").removeAttr("indicate");$(this).closest(".keyword").remove();setTimeout(function(){e.find("input")[0].focus()},500);if(typeof(f.inputCallback)==="function"){f.inputCallback.call(this)}},focus:function(h){e.addClass("focus");e.find("input")[0].focus();$(document).one("mousedown",a.blur)},blur:function(i){var h=function(j,n,k){if(!k||!k.offset()){return false}var m=[k.offset().left,k.offset().left+k.outerWidth()];var l=[k.offset().top,k.offset().top+k.outerHeight()];return j>=m[0]&&j<=m[1]&&n>=l[0]&&n<=l[1]};if(h(i.pageX,i.pageY,e)){$(document).one("mousedown",a.blur)}else{$(".indicate").remove();$("[indicate]").removeAttr("indicate");e.find("input").val($.trim(e.find("input").val()));e.removeClass("focus");a.inputFinish(true)}}};e.attr("data-reset-value",f.initData.join(","));e.attr("data-refuse-value",f.refuseData.join(","));e.attr("data-refuse-reason",f.refuseDataReason);e.attr("data-input-err",f.inputErr);e.attr("data-regexp",f.regExp);e.find("input").val("");$(".indicate").remove();$("[indicate]").removeAttr("indicate");$(document).off("click",".keyword",a.remove).on("click",".keyword",a.remove);e.off("click").on("click",a.focus);e.off("keydown","input").on("keydown","input",a.input);if(typeof(f.callback)==="function"){f.callback.call(this)}},resetElfKeyword:function(){var d=$(this);var c=d.attr("data-reset-value").split(",");var a=[];for(var b=0;b<c.length;b++){if(c[b]!==""){a.push('<span class="keyword">'+c[b]+"</span>")}}d.find(".keyword").remove();d.prepend(a.join(""));d.find("input").val("");$(".indicate").remove();$("[indicate]").removeAttr("indicate")},setElfKeyword:function(_arr){if(typeof(_arr)==="undefined"){if(typeof(elf)!=="undefined"&&typeof(elf.alertInfo)!=="undefined"){elf.alertInfo("数据无效,请检查参数")}return false}var $this=$(this);var thisRregexp=eval($this.attr("data-regexp"));var refuseData=$this.attr("data-refuse-value").split(",");var resetData=_arr;var keywordHtml=[];var refuseKeywords=[];var errKeywords=[];for(var i=0;i<resetData.length;i++){if($.inArray(resetData[i],refuseData)>=0){refuseKeywords.push(resetData[i])}if(thisRregexp.test(resetData[i])){keywordHtml.push('<span class="keyword">'+resetData[i]+"</span>")}else{errKeywords.push(resetData[i])}}if(refuseKeywords.length>0){console.log("setKeyword方法未成功执行("+$this.attr("data-refuse-reason")+"):"+refuseKeywords.join(","));return false}else{if(errKeywords.length>0){console.log("setKeyword方法未成功执行("+$this.attr("data-input-err")+"):"+errKeywords.join(","));return false}}$this.find(".keyword").remove();$this.prepend(keywordHtml.join(""));$this.attr("data-reset-value",_arr.join(","))},getElfKeyword:function(){var a=[];$(this).find(".keyword").each(function(b,c){a.push($.trim($(c).text()))});return a}});