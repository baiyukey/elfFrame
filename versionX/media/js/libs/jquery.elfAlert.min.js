$(function(){$.fn.extend({elfAlert:function(w){w=$.extend({fadeTime:320,mark:true,markOpacity:0.15,markColor:"#FFF",callback:false,callbackArr:null,closeBtn:true,animate:100,linkLine:false,scroll:false},w);w.animate=w.linkLine?0:w.animate;w.mark=w.linkLine?false:w.mark;var L,o;L=$(window.top);o=$(window.top.document);var e=$(this);if(e.length===0){alert("对象未找到");return false}var t=0;var G=(Math.random()*1000).toFixed(0);var g=e.outerWidth();var x=e.outerHeight();var y=e.height();var a=e.css("display");if(x>o.height()){y=o.height()-(x-y);x=o.height()}var s="bodyMark_"+G;var h="disableMark_"+G;var B="showPanel_"+G;var q="recordPlace_"+G;var A="closeBtn_"+G;var I='<div id="'+s+'" class="bodyMark" style="position:absolute; width:'+o.width()+"px; height:"+o.height()+"px; z-index:888888; left:0; top:0; background:"+w.markColor+"; display:none;_position:absolute;_height:"+o.outerHeight()+';"></div>';var F='<div id="'+B+'" data-fade-time="'+w.fadeTime+'" data-history-display="'+a+'" class="showPanel" style="display:none; width:'+g+"px; height:"+x+'px; position:absolute;_position:absolute; left:0; top:0;"><a href="#" id="'+A+'" class="elfAlertClose" style="position:absolute; right:0; top:0; display:block; z-index:1;"></a><div class="elfAlertCont" style="position:absolute;padding:0;"></div></div><div id="'+h+'" class="disableMark" style="position:absolute; display:none; width:'+o.width()+"px; height:"+o.height()+"px; z-index:999999; left:0; top:0; background:#ffffff;_position:absolute;_height:"+o.outerHeight()+';"></div>';if(w.linkLine){var v=w.linkLine.type==="custom"?w.linkLine.target:$(w.linkLine.target);if(window!==window.top){var N=$(window.top.document).find('iframe[src="'+window.location.pathname+'"]')}var b=v.offset().left+(N.length>0?N.offset().left:0);var c=v.offset().top+(N.length>0?N.offset().top:0);var f=v.outerWidth();var i={linePath:[],sourceBorderPath:[],stroke:"#FFFFFF",fill:"#FFFFFF",lineWidth:"1"};i.linePath.push("M"+(Math.round(b)-0.5)+" "+(Math.round(c)-0.5));i.linePath.push("L"+(Math.round(b)-0.5)+" "+(Math.round(c)-0.5));i.sourceBorderPath.push("M"+(Math.round(b)-0.5)+" "+(Math.round(c)+5)+" l 0 -5.5 l 5.5 0");i.sourceBorderPath.push("M"+(Math.round(b+f)+0.5)+" "+(Math.round(c)+5)+" l 0 -5.5 l -5.5 0");i.sourceBorderPath.push("M"+(Math.round(b+f)+0.5)+" "+(Math.round(c+v.outerHeight())-5)+" l 0 5.5 l -5.5 0");i.sourceBorderPath.push("M"+(Math.round(b)-0.5)+" "+(Math.round(c+v.outerHeight())-5)+" l 0 5.5 l 5.5 0");var d=o.find("#bodyMarkSvg");var r=o.find("#"+B+"Line");var p=o.find("#"+B+"SourceBorder");if(d.length===0){var C='<svg id="bodyMarkSvg" xmlns="http://www.w3.org/2000/svg" version="1.1" class="bodyMarkSvg" style="position:absolute; width:'+o.width()+"px; height:"+o.height()+'px; z-index:888889; left:0; top:0;">';var m='<path id="'+B+'Line" d="'+i.linePath.join(" ")+'" stroke="'+i.stroke+'" stroke-width="'+i.lineWidth+'" fill="none"></path>';var z='<path id="'+B+'SourceBorder" d="'+i.sourceBorderPath.join(" ")+'" stroke="'+i.stroke+'" stroke-width="'+i.lineWidth+'" fill="none"></path>';o.find("body").append(C+z+m+"</svg>");d=o.find("#bodyMarkSvg");r=o.find("#"+B+"Line");p=o.find("#"+B+"SourceBorder")}else{if(r.length===0){var u=document.createElementNS("http://www.w3.org/2000/svg","path");u.id=B+"Line";u.setAttribute("d",i.linePath.join(" "));u.setAttribute("stroke",i.stroke);u.setAttribute("stroke-width",i.lineWidth);u.setAttribute("fill","none");d.append(u);r=o.find("#"+B+"Line")}else{r.attr("d",i.linePath.join(" "));r.attr("stroke",i.stroke);r.attr("stroke-width",i.strokeWidth)}if(p.length===0){var J=document.createElementNS("http://www.w3.org/2000/svg","path");J.id=B+"SourceBorder";J.setAttribute("d",i.sourceBorderPath.join(" "));J.setAttribute("stroke",i.stroke);J.setAttribute("stroke-width",i.lineWidth);J.setAttribute("fill","none");d.append(J);p=o.find("#"+B+"SourceBorder")}else{p.attr("d",i.sourceBorderPath.join(" "));p.attr("stroke",i.stroke);p.attr("stroke-width",i.strokeWidth)}}r.show();p.show();d.show()}o.find("body").append(I);o.find("body").append(F);e.before('<div id="'+q+'" style="display:none;"></div>');var H=o.find("#"+s);var n=o.find("#"+B);var K=o.find("#"+h);var E=e.closest("body").find("#"+q);var R=function(){var T=(o.width()-g)*0.5;var S=0;var U=o.scrollTop();if((U+x)>o.height()){S=o.height()-x}else{S=U+((L.height()-x)*0.4);S<U?S=U:null}S=Math.max(0,S);this.alertX=T;this.alertY=S};var M=function(T,S){if(w.linkLine===false){return false}var V=(n.offset().left+(n.outerWidth()/2))>(b+(f/2))?T:(T+n.outerWidth());var U=S+(n.find(".alertTitle").length>0?n.find(".alertTitle").height():0)+1;U=Math.round(U)+0.5;i.linePath[0]="M"+(Number(V)!==Number(T)?b:b+f)+" "+c;i.linePath[1]="L"+(V+(Number(V)!==Number(T)?10:-10))+" "+U;i.linePath[2]=" "+V+" "+U;r.attr("d",i.linePath.join(" "))};var P=function(){o.find(".showPanel").css({"z-index":999996});$(this).closest(".showPanel").css({"z-index":999997})};var k=function(){K.hide();e.find("div.alertTitle").length>0?t=e.find(".alertTitle").outerHeight():null;if(n.find("div.alertCont").length>0){var S=n.find("div.alertCont");S.css({height:(y-parseInt(S.css("padding-top"))-parseInt(S.css("padding-bottom"))-t),"overflow-y":"auto"})}l();w.callback&&typeof(w.callback)==="function"?w.callback.call(this,w.callbackArr):null;n.find("input[type='text']:visible").length>0?n.find("input[type='text']:visible:eq(0)").focus():n.find("textarea:eq(0)").focus()};var l=function(){o.find(".bodyMark").css({width:L.width(),height:o.height()});o.find(".disableMark").css({width:L.width(),height:o.height()})};var j=function(){e.show().insertBefore(n.find("div.elfAlertCont"));var S={};if(w.linkLine){S.alertX=b-n.outerWidth()-50;S.alertX=Math.max(f+50,S.alertX);S.alertX=Math.min((o.width()-n.outerWidth()),S.alertX);S.alertY=c-(n.outerHeight()/2)-50;S.alertY=Math.max(0,S.alertY);S.alertY=Math.min(o.height()-n.height(),S.alertY)}else{S=new R()}K.css({opacity:"0.01",display:"block"});n.css({left:S.alertX,top:(S.alertY-w.animate),"z-index":999998,opacity:"0.1",display:"block"});if($.fn.smooth){n.smoothStop(true,false).smooth({top:(S.alertY),opacity:"1"},w.fadeTime,k,"easeOut")}else{n.stop(true,false).animate({top:(S.alertY),opacity:"1"},w.fadeTime,k)}M(S.alertX,S.alertY)};var Q=function(T){T.preventDefault();var S=function(){if($(("#"+q)).length===0){if(!o||!o[0].getElementsByTagName("iframe")||!o[0].getElementsByTagName("iframe")[0].contentWindow){return false}$(o[0].getElementsByTagName("iframe")[0].contentWindow.document).find("#"+q).after(n.find(e).css({display:a}))}else{$("#"+q).after(n.find(e).css({display:a}))}E.after(n.find(e).css({display:a}));E.remove();n.remove();K.remove();if(o.find(".bodyMark.wantShow").length>1){H.siblings(".bodyMark.wantShow:eq(0)").show();H[$.fn.smooth?"smoothStop":"stop"](true,false).remove()}else{if(o.find(".bodyMark.wantShow").length===1){H[$.fn.smooth?"smoothStop":"stop"](true,false);if(H.hasClass("wantShow")){H[$.fn.smooth?"smoothOut":"fadeOut"](w.fadeTime,function(){H.remove()})}else{H[$.fn.smooth?"smoothStop":"stop"](true,false).remove()}}else{H[$.fn.smooth?"smoothStop":"stop"](true,false).remove()}}if(w.linkLine!==false){r.remove();p.remove();d.hide()}if(!w.scroll){O()}};K.show();n.off("click","#"+A);if(w.linkLine){r.attr("d","")}if($.fn.smooth){n.smoothStop(true,false).smooth({top:(n.offset().top-w.animate),opacity:0},w.fadeTime,S,"easeIn")}else{n.stop(true,false).animate({top:(n.offset().top-w.animate),opacity:0},w.fadeTime,S)}};var D=function(){var S=o.scrollTop();o.on("scroll.unable",function(T){o.scrollTop(S)})};var O=function(){o.off("scroll.unable")};if(w.closeBtn===false){o.find("#"+A).hide()}if(w.mark){H.addClass("wantShow").css("opacity",w.markOpacity);if(o.find(".bodyMark.wantShow").length===1){o.find(".bodyMark.wantShow").eq(0)[$.fn.smooth?"smoothIn":"smoothIn"](300,j)}else{if(o.find(".bodyMark.wantShow").length>1){o.find(".bodyMark.wantShow").eq(0)[$.fn.smooth?"smoothIn":"smoothIn"](0,j).siblings(".bodyMark.wantShow").hide()}else{j()}}}else{j()}if(w.linkLine!==false){o.one("click","#bodyMarkSvg",Q)}if(!w.scroll){D()}n.on("click","#"+A,Q);n.on("click","a.cancel",Q);n.find(".alertTitle").off("mousedown");n.on("mousedown",".alertTitle",function(U){var Y,W,S,ad,aa,T,Z,X;Y=n.offset().left;W=n.offset().top;S=U.pageX;ad=U.pageY;aa=n.closest("body").width();T=n.closest("body").height();var V=function(ae){Z=ae.pageX-S+Y;X=ae.pageY-ad+W;if(Z<=0){return false}if(Z>=(aa-n.width())){return false}if(X<=0){return false}if(X>=(T-n.height())){return false}n.css({left:Z,top:X});M(Z,X)};n.css({cursor:"move"});var ac=window.getComputedStyle($("body")[0])["user-select"];n.closest("body").css({"-moz-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","-khtml-user-select":"none","user-select":"none"});var ab=function(){o[0].removeEventListener("mousemove",V);o[0].removeEventListener("mouseup",ab);n.css({cursor:""});n.closest("body").css({"-moz-user-select":ac,"-webkit-user-select":ac,"-ms-user-select":ac,"-khtml-user-select":ac,"user-select":ac})};o[0].addEventListener("mousemove",V);o[0].addEventListener("mouseup",ab)});n.on("mousedown",this,P);if(o.find(".bodyMark").length>0){o.find(".bodyMark").off("click").on("click",function(){if(o.find(".showPanel").length===1){o.find(".showPanel").find(".elfAlertClose").trigger("click");o.find(".bodyMark").off("click")}})}return e},elfAlertExit:function(f){var c=$(this);var b=c.closest(".showPanel").attr("id");var a=$("#"+b).css("opacity");var e=$(window.top.document);f=$.extend({fadeTime:parseInt(e.find("#"+b).attr("data-fade-time")),callback:false,callbackArr:null,animate:100},f);var d=function(){if(e.find("#"+b).length===1&&e.find("#"+b).css("opacity")===a){var g=b.replace("showPanel","");var j=e.find("#"+b).attr("data-history-display");var i=$("#recordPlace"+g);var h=function(){if(i.length===0){$(e[0].getElementsByTagName("iframe")[0].contentWindow.document).find("#recordPlace"+g).after($("#showPanel"+g).find(c).css({display:j}));$(e[0].getElementsByTagName("iframe")[0].contentWindow.document).find("#recordPlace"+g).remove()}else{i.after($("#showPanel"+g).find(c).css({display:j}));i.remove()}e.find("#disableMark"+g).remove();e.find("#showPanel"+g).remove();if(e.find(".bodyMark.wantShow").length>1){e.find("#bodyMark"+g).siblings(".bodyMark.wantShow:eq(0)").show();e.find("#bodyMark"+g)[$.fn.smooth?"smoothStop":"stop"](true,false).remove()}else{if(e.find(".bodyMark.wantShow").length===1){if(e.find("#bodyMark"+g).hasClass("wantShow")){e.find("#bodyMark"+g)[$.fn.smooth?"smoothStop":"stop"](true,false);e.find("#bodyMark"+g)[$.fn.smooth?"smoothOut":"fadeOut"](f.fadeTime,function(){e.find("#bodyMark"+g).remove()})}else{e.find("#bodyMark"+g)[$.fn.smooth?"smoothStop":"stop"](true,false).remove()}}else{e.find("#bodyMark"+g)[$.fn.smooth?"smoothStop":"stop"](true,false).remove()}}f.callback&&typeof(f.callback)==="function"?f.callback.call(this,f.callbackArr):null};e.find("#"+b+"Line").remove();e.find("#"+b+"SourceBorder").remove();if($.fn.smooth){e.find("#showPanel"+g).smoothStop(true,false).smooth({top:(e.find("#showPanel"+g).offset().top-(f.linkLine?0:f.animate)),opacity:0},f.fadeTime,h,"easeIn")}else{e.find("#showPanel"+g).stop(true,false).animate({top:(e.find("#showPanel"+g).offset().top-(f.linkLine?0:f.animate)),opacity:0},f.fadeTime).fadeOut(0,h)}}else{f.callback&&typeof(f.callback)==="function"?f.callback.call(this,f.callbackArr):null}};c.closest(".showPanel").find("a.elfAlertClose").trigger("click");setTimeout(d,f.fadeTime);return $(this)}})});