(function(a){a.fn.extend({elfBackground:function(g){var f=a.extend({fill:"rgba(21,39,68,0.6)",borderColor:"#05607F",borderWidth:1,cutLeftTop:10,cutLeftBottom:3,cutRightTop:3,cutRightBottom:10,cut:"",talkBubble:{},callback:null},g);f.talkBubble=a.extend({angle:0,distance:0,beginWidth:20},f.talkBubble);if(f.cut!==""){var e=f.cut.split(" ");f.cutLeftTop=e[0]||f.cutLeftTop;f.cutRightTop=e[1]||f.cutRightTop;f.cutRightBottom=e[2]||f.cutRightBottom;f.cutLeftBottom=e[3]||f.cutLeftBottom;f.cutLeftTop=Number(f.cutLeftTop);f.cutRightTop=Number(f.cutRightTop);f.cutRightBottom=Number(f.cutRightBottom);f.cutLeftBottom=Number(f.cutLeftBottom)}var d=a(this).length;var b=function(h,m,l){var n=[0,0];n[0]=Math.atan2(h,m)/Math.PI/2*360;n[1]=90-n[0];var j={top:[],right:[],bottom:[],left:[]};j.top=[360-n[0],n[0]];j.right=[90-n[1],90+n[1]];j.bottom=[180-n[0],180+n[0]];j.left=[270-n[1],270+n[1]];var p=Math.abs((l+360)%360);var o=p<=j.top[1]||p>j.top[0]?"top":"unKnow";if(o==="unKnow"){for(var i in j){if(p>j[i][0]&&p<=j[i][1]){o=i;break}}}return o};var c=function(n,o,s,p){var l=[];var t=0;var m=Math.abs((f.talkBubble.angle+360)%360);var j=function(w,x){return Math.tan(2*Math.PI/360*(Math.abs(w%90)))*x};var v=1;var k=0,i=0,h=0,u=0,r=0,q=0;switch(s){case"top":t=o/2;v=m>270?-1:1;k=(n/2)+j((m>270?360-m:-m),t)*v-p.talkBubble.beginWidth/2;k=Math.max(k,f.cutLeftTop);i=(n/2)+j((m>270?360-m:-m),t+p.talkBubble.distance)*v;i=Math.max(0.5,i);i=Math.min(n+f.talkBubble.distance-0.5,i);h=k+p.talkBubble.beginWidth;h=Math.min(h,(n-f.cutRightTop));k=h-p.talkBubble.beginWidth;l.push(k+","+(p.talkBubble.distance+0.5));l.push(i+","+0.5);l.push(h+","+(p.talkBubble.distance+0.5));break;case"right":t=n/2;v=m>90?1:-1;u=(o/2)+j((m<90?90-m:-m),t)*v-p.talkBubble.beginWidth/2;u=Math.max(u,f.cutRightTop);r=(o/2)+j((m<90?90-m:-m),t+p.talkBubble.distance)*v;r=Math.max(0.5,r);r=Math.min(o+f.talkBubble.distance,r);q=u+p.talkBubble.beginWidth;q=Math.min(q,o-f.cutRightBottom);u=q-p.talkBubble.beginWidth;l.push((n-0.5)+","+u);l.push((n-0.5+p.talkBubble.distance+0.5)+","+r);l.push((n-0.5)+","+q);break;case"bottom":t=o/2;v=m>180?-1:1;k=(n/2)+j((m<180?180-m:m),t)*v+p.talkBubble.beginWidth/2;k=Math.min(k,(n-f.cutLeftBottom));i=(n/2)+j((m<180?180-m:-m),t+p.talkBubble.distance)*v;i=Math.max(0.5,i);i=Math.min(n+f.talkBubble.distance-0.5,i);h=k-p.talkBubble.beginWidth;h=Math.max(h,f.cutLeftBottom);k=h+p.talkBubble.beginWidth;l.push(k+","+(o-0.5));l.push(i+","+(o+p.talkBubble.distance-0.5));l.push(h+","+(o-0.5));break;case"left":t=n/2;v=m>270?-1:1;u=(o/2)+j((m<270?270-m:-m),t)*v+p.talkBubble.beginWidth/2;u=Math.min(u,(o-f.cutLeftBottom));r=(o/2)+j((m<270?270-m:-m),t+p.talkBubble.distance)*v;r=Math.max(0.5,r);r=Math.min(o+f.talkBubble.distance,r);q=u-p.talkBubble.beginWidth;q=Math.max(q,f.cutLeftTop);u=q+p.talkBubble.beginWidth;l.push((f.talkBubble.distance+0.5)+","+u);l.push(0.5+","+r);l.push((f.talkBubble.distance+0.5)+","+q);break;default:break}return l.join(" ")};a(this).each(function(m,p){var q=a(p);var o=q.outerWidth();var j=q.outerHeight();var l=b(o,j,f.talkBubble.angle);var h,s,k;if(f.talkBubble.distance!==0){h=c(o,j,l,f);if(l==="top"){s=f.talkBubble.distance;k=0}else{if(l==="left"){s=0;k=f.talkBubble.distance}else{s=0;k=0}}}else{h="";s=0;k=0}var t="position:absolute;width:"+(o+f.talkBubble.distance)+"px;height:"+(j+f.talkBubble.distance)+"px;z-index:-1;left:"+(0-k)+"px;top:"+(0-s)+"px;";var r=[];r.push((f.cutLeftTop+k)+","+((f.borderWidth/2)+s));if(l==="top"&&f.talkBubble.distance!==0){r.push(h)}r.push((q.outerWidth()-f.cutRightTop+k)+","+((f.borderWidth/2)+s));r.push((q.outerWidth()-(f.borderWidth/2)+k)+","+(f.cutRightTop+s));if(l==="right"&&f.talkBubble.distance!==0){r.push(h)}r.push((q.outerWidth()-(f.borderWidth/2)+k)+","+((q.outerHeight()-f.cutRightBottom)+s));r.push((q.outerWidth()-f.cutRightBottom+k)+","+(q.outerHeight()-f.borderWidth/2+s));if(l==="bottom"&&f.talkBubble.distance!==0){r.push(h)}r.push((f.cutLeftBottom+k)+","+(q.outerHeight()-f.borderWidth/2+s));r.push((f.borderWidth/2+k)+","+(q.outerHeight()-f.cutLeftBottom+s));if(l==="left"&&f.talkBubble.distance!==0){r.push(h)}r.push((f.borderWidth/2+k)+","+(f.cutLeftTop+s));var n='<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" version="1.1" style="'+t+'" class="elfBackground"><polygon points="'+r.join(" ")+'" style="fill:'+f.fill+"; stroke:"+f.borderColor+";stroke-width:"+f.borderWidth+'"/></svg>';if(q.attr("data-elfBackground")==="true"){q.find("svg.elfBackground").attr("style",t);q.find("svg.elfBackground polygon").eq(0).attr("points",r.join(" ")).attr("style",("fill:"+f.fill+"; stroke:"+f.borderColor+";stroke-width:"+f.borderWidth))}else{if(a.inArray(q[0].style.position,["relative","absolute"])<0){q.css({position:"relative"})}q.attr("data-elfBackground","true").prepend(n)}if(m===(d-1)&&f.callback!==null){f.callback.call(this)}});return this.each(function(){})}})})(jQuery);