$.fn.extend({setCache:function(i){var d=$(this);var g=false;var h=typeof(i)==="number"?i:5;var b;var f=function(o){var q=o;var p=[];if(typeof(localStorage)==="undefined"){alert("为了使用学习功能,请将您的浏览器升级到现代浏览器,例如chrome等");return false}if(!localStorage.getItem(q)){localStorage.setItem(q,"[]")}p=JSON.parse(localStorage.getItem(q));this.maxLength=localStorage.getItem(q+"MaxLength")||0;localStorage.setItem(q+"MaxLength",this.maxLength);this.setItem=function(r){if(typeof(r)!=="undefined"&&r!==""){p.unshift(r.replace(/'/g,""))}p=elf.removeRepeat(p);if(p.length>this.maxLength){p.splice(this.maxLength)}localStorage.setItem(q,elf.objToStr(p));localStorage.setItem(q+"MaxLength",this.maxLength)};this.getData=function(){p=JSON.parse(localStorage.getItem(q));return p.slice(0,this.maxLength)};this.clear=function(){localStorage.setItem(q,"[]");p=[]}};var j=function(p){var r=typeof(p)!=="undefined"?p:g;var q=r.attr("id")?r:r.closest("[id]");var o=q.length>0?q.attr("id"):"publicSearch";this.localStorage=o;this.searchHistory="searchHistory_for_"+o};var l=function(p){var o="";for(var q=0;q<p.length;q++){o+='<li><a data-value="'+p[q]["value"]+'" href="#">'+p[q]["text"]+"</a></li>"}return o};var e=function(){var p=$("#"+b.searchHistory);var o=Number(localStorage.getItem(b.localStorage+"MaxLength"));if(o<=1){p.find(".searchHistoryOption").find(".subtract").addClass("disable")}else{p.find(".searchHistoryOption").find(".subtract").removeClass("disable")}};var a=function(p,o){if(typeof(o)==="undefined"){o=-1}if(o>=p.find("ul:visible").children("li").length){o=0}else{if(o<0){o=p.find("ul:visible").find("li").length-1}}p.find(".focusBg").removeClass("focusBg");p.find("ul:visible").eq(0).attr("data-focus-index",o).find("li:eq("+o+") a").addClass("focusBg")};var n=function(p){var o=$.trim(p);if(o!==""){var q=new f(b.localStorage);q.maxLength=!localStorage.getItem(b.localStorage+"MaxLength")||Number(localStorage.getItem(b.localStorage+"MaxLength"))===0||h===0?h:Number(localStorage.getItem(b.localStorage+"MaxLength"));q.setItem(o)}};var m=function(o){return function(p){p.preventDefault();if($(this).hasClass("disable")){return false}var s=$(this);var r=s.closest("ul");var q=$.trim(s.find("a").attr("data-value"));o.val(q).trigger("input").removeClass("activeInput");r.attr("data-focus-index","-1").parent().removeClass("unfold");document.removeEventListener("click",k)}};var k=function(o){o.preventDefault();o.stopPropagation();if($(o.target).hasClass("activeInput")){return false}else{if($(o.target).closest(".searchHistory.unfold").length>0){return false}else{$(".activeInput").trigger("click");document.removeEventListener("click",k)}}};var c=function(s){s.preventDefault();var r=$(this);if(r.hasClass("disable")){return false}var o=function(){var v=new f(b.localStorage);var u=v.getData();var w=[];for(var t=0;t<u.length;t++){w.push({text:u[t],value:u[t]})}$("#"+b.searchHistory).find("ul").html(l(w))};var q=function(u){var t=localStorage.getItem(b.localStorage+"MaxLength");if(t>1&&u==="subtract"){t--}else{if(u==="add"){t++}}localStorage.setItem(b.localStorage+"MaxLength",t);r.closest(".searchHistoryOption").find(".maxLength").text(t);e();o()};var p=function(){localStorage.setItem(b.localStorage,"");o()};if(r.hasClass("clear")){p()}else{if(r.hasClass("subtract")){q("subtract")}else{if(r.hasClass("add")){q("add")}}}};window.clickElfSetCacheInput=function(p){p.preventDefault();var o=$(p.target);if($(this).hasClass("disable")){return false}var r=function(t){var s=new j(t);var v=s.searchHistory;var u=$("#"+v);if(t.val()===""&&t.attr("placeholder")===t.attr("data-placeholder")){t.val("")}else{if(t.val()===""&&t.attr("placeholder")!==t.attr("data-placeholder")){t.attr("placeholder",t.attr("data-placeholder"))}else{if(t.val()!==""){t.attr("placeholder",t.val())}}}u.removeClass("unfold").find("ul").attr("data-focus-index","-1");t.removeClass("activeInput")};var q=function(w){b=new j(w);if(w.attr("placeholder")!==""){w.attr("data-placeholder",w.attr("placeholder"))}if(h===0){var D=new f(b.localStorage);D.maxLength=h;D.setItem()}var A=b.localStorage;var H=b.searchHistory;var z=$("body");var F=window.getComputedStyle(w[0]).fontSize;var v=!localStorage.getItem(A+"MaxLength")||Number(localStorage.getItem(A+"MaxLength"))===0||h===0?h:Number(localStorage.getItem(A+"MaxLength"));var t=false;if(!document.getElementById(H)){z.append('<div class="searchHistory" id="'+H+'"><ul data-focus-index="-1"></ul><div class="searchHistoryOption" style="white-space:nowrap;text-align:right; padding:5px;color:#555555;"><a class="searchOption clear" href="#">清空</a><p style="display:inline-block;margin-left:1em;"><span>最大缓存条数<i class="iconQuestionSign" style="margin:0 0.25em; vertical-align:baseline" title="缓存仅存于本地浏览器中."></i>:</span><a class="searchOption subtract'+(v<=1?" disable":"")+'" href="#">-</a><span class="maxLength">'+h+'</span><a class="searchOption add" href="#">+</a></p></div></div>');t=$("#"+H)}else{t=$("#"+H)}var s=z.height();var I=w.offset().top;var E=s-I;var C=t.outerHeight()+w.outerHeight()-1;var y=function(J){if(typeof(J)!=="undefined"&&J==="old"){if(C>E){t.attr("style","");t.css({height:E-(E/10),"overflow-y":"scroll"})}}else{if(C>E&&C<I){t.css({"margin-top":(-1*C)})}}};y();if(w.val()===""&&w.attr("placeholder")===w.attr("data-placeholder")){}else{w.attr("placeholder",w.val())}t.find("ul").attr("data-focus-index","-1").find(".focusBg").removeClass("focusBg");t.attr("style","").css({"font-size":F,position:"absolute","min-width":w.outerWidth(),left:w.offset().left,top:w.offset().top+w.outerHeight()}).find(".maxLength").text(v);var G=new f(A);G.maxLength=v;var x=G.getData();var u=[];for(var B=0;B<x.length;B++){u.push({text:x[B],value:x[B]})}if(u.length>0){t.find(".searchHistoryOption").show();e()}else{t.find(".searchHistoryOption").hide()}t.addClass("unfold").find("ul").html(l(u));w.addClass("activeInput");t.off("click","ul li",m(w));t.one("click","ul li",m(w));document.removeEventListener("click",k);document.addEventListener("click",k);$(document).off("click",".searchOption",c);$(document).on("click",".searchOption",c)};if(o.hasClass("activeInput")){r(o)}else{$(".activeInput").trigger("click");q(o)}};window.checkElfSetCacheInputKeyup=function(t){if($(t.target).hasClass("disable")){return false}var o=b.localStorage;var r=b.searchHistory;var q=$("#"+r);var p;var s=function(A){if(A===13){t.preventDefault();p=q.find("ul:visible").attr("data-focus-index");if(Number(p)>=0){q.find("ul li:eq("+p+")").trigger("click")}else{n($(t.target).val());$(t.target).trigger("click")}a(q,p)}else{if(A===9){t.preventDefault();$(t.target).trigger("click")}else{if(A===27){t.preventDefault();if(document.getElementById(r)&&q.hasClass("unfold")){$(t.target).trigger("click");p=-1;a(q,p)}}else{if(A===38){t.preventDefault();if(document.getElementById(r)&&q.hasClass("unfold")){p=q.find("ul").attr("data-focus-index")||q.find("ul").find("li").length;p--;a(q,p)}}else{if(A===40){t.preventDefault();if(document.getElementById(r)&&q.hasClass("unfold")){p=q.find("ul").attr("data-focus-index")||-1;p++;a(q,p)}}else{var w=!localStorage.getItem(o+"MaxLength")||Number(localStorage.getItem(o+"MaxLength"))===0||h===0?h:Number(localStorage.getItem(o+"MaxLength"));if(!document.getElementById(r)){var B=window.getComputedStyle($(t.target)[0]).fontSize;$("body").append('<div class="searchHistory" id="'+r+'" style="font-size:'+B+'"><ul data-focus-index="-1"></ul><div class="searchHistoryOption" style="white-space:nowrap;text-align:right; padding:5px;color:#555555"><a class="control clear" href="#">清空</a><p style="display:inline-block;margin-left:1em;"><span title="缓存仅存于本地浏览器中.">最大缓存条数<i class="iconQuestionSign" style="margin:0 0.25em; vertical-align:baseline"></i>:</span><a class="control subtract'+(w<=1?" disable":"")+'" href="#">-</a><span class="maxLength">'+w+'</span><a class="control add" href="#">+</a></p></div></div>')}q=$("#"+r);q.css({position:"absolute","min-width":$(t.target).outerWidth(),left:$(t.target).offset().left,top:$(t.target).offset().top+$(t.target).outerHeight()}).addClass("unfold");var D=new f(o);D.maxLength=w;var y=D.getData();var v=[];for(var z=0;z<y.length;z++){v.push({text:y[z],value:y[z]})}var u=$.trim($(t.target).val());if(u===""){q.find("ul").html(l(v));q.find("maxLength").text(w);if(v.length===0){q.find(".searchHistoryOption").hide()}else{q.find(".searchHistoryOption").show();e()}}else{if(typeof(Fuse)!=="function"){console.log("缺少juse.js,搜索功能取消");return false}var x=new Fuse(v,{keys:["text"]});var C=x.search(u);q.find("ul").html(l(C));q.find(".searchHistoryOption").hide()}}}}}}};if(typeof(window.waitSaveSearchCache)!=="undefined"){clearTimeout(window.waitSaveSearchCache)}window.waitSaveSearchCache=setTimeout(n,3000,$(t.target).val());s(t.getKey())};d.off("click",clickElfSetCacheInput).on("click",clickElfSetCacheInput);d.off("keyup",checkElfSetCacheInputKeyup).on("keyup",checkElfSetCacheInputKeyup);return this.each(function(){})}});